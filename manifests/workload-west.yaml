apiVersion: v1
kind: Namespace
metadata:
  name: app-a-consumer
---
apiVersion: v1
kind: Namespace
metadata:
  name: app-a-producer
---
apiVersion: v1
kind: Namespace
metadata:
  name: app-b-consumer
---
apiVersion: v1
kind: Namespace
metadata:
  name: app-b-producer
---
apiVersion: v1
kind: Namespace
metadata:
  name: app-c-producer
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-a-consumer
  namespace: app-a-consumer
  labels:
    app: app-a-consumer
spec:
  replicas: 2
  selector:
    matchLabels:
      app: app-a-consumer
  template:
    metadata:
      labels:
        app: app-a-consumer
    spec:
      containers:
        - name: app-a-consumer
          image: mccutchen/go-httpbin:latest
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8080
          readinessProbe:
            httpGet:
              path: /status/200
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /status/200
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            failureThreshold: 3
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 250m
              memory: 128Mi
---
apiVersion: v1
kind: Service
metadata:
  name: app-a-consumer
  namespace: app-a-consumer
  labels:
    app: app-a-consumer
  annotations:
    io.cilium/global-service: "true"
spec:
  type: ClusterIP
  selector:
    app: app-a-consumer
  ports:
    - name: http
      port: 80
      targetPort: http
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-b-consumer
  namespace: app-b-consumer
  labels:
    app: app-b-consumer
spec:
  replicas: 2
  selector:
    matchLabels:
      app: app-b-consumer
  template:
    metadata:
      labels:
        app: app-b-consumer
    spec:
      containers:
        - name: app-b-consumer
          image: mccutchen/go-httpbin:latest
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8080
          readinessProbe:
            httpGet:
              path: /status/200
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /status/200
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            failureThreshold: 3
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 250m
              memory: 128Mi
---
apiVersion: v1
kind: Service
metadata:
  name: app-b-consumer
  namespace: app-b-consumer
  labels:
    app: app-b-consumer
spec:
  type: ClusterIP
  selector:
    app: app-b-consumer
  ports:
    - name: http
      port: 80
      targetPort: http
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-httpbin-script
  namespace: app-a-producer
data:
  script.js: |
    import http from "k6/http";
    import { sleep } from "k6";

    export const options = {
      vus: __ENV.VUS ? parseInt(__ENV.VUS) : 5,
      duration: __ENV.DURATION || "24h",
      thresholds: { http_req_failed: ["rate<0.10"] },
    };

    const BASE = __ENV.BASE_URL;
    const endpoints = [
      "/get","/anything","/headers","/uuid","/ip","/user-agent","/cookies",
      "/delay/1","/delay/2","/delay/3",
      "/status/200","/status/204","/status/301","/status/404","/status/418","/status/500"
    ];
    const methods = ["GET","POST","PUT","PATCH","DELETE"];
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    export default function () {
      const m = pick(methods);
      let ep = pick(endpoints);
      if (m === "POST") ep = "/post";
      if (m === "PUT") ep = "/put";
      if (m === "PATCH") ep = "/patch";
      if (m === "DELETE") ep = "/delete";

      const url = `${BASE}${ep}`;
      const params = { headers: { "Content-Type": "application/json", "X-Demo": "k6-producer" } };

      if (m === "GET" || m === "DELETE") {
        http.request(m, url, null, params);
      } else {
        const payload = JSON.stringify({ ts: Date.now(), note: "random load", rnd: Math.random() });
        http.request(m, url, payload, params);
      }
      sleep(Math.random()*1.5 + 0.2);
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-a-producer
  namespace: app-a-producer
  labels:
    app: app-a-producer
spec:
  replicas: 1
  selector:
    matchLabels:
      app: app-a-producer
  template:
    metadata:
      labels:
        app: app-a-producer
    spec:
      containers:
        - name: k6
          image: grafana/k6:0.49.0
          imagePullPolicy: IfNotPresent
          args: ["run","/scripts/script.js"]
          env:
            - name: BASE_URL
              value: http://app-a-consumer.app-a-consumer.svc.cluster.local
            - name: VUS
              value: "5"
            - name: DURATION
              value: 24h
          volumeMounts:
            - name: k6-scripts
              mountPath: /scripts
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 300m
              memory: 256Mi
      volumes:
        - name: k6-scripts
          configMap:
            name: k6-httpbin-script
            items:
              - key: script.js
                path: script.js
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-httpbin-script
  namespace: app-b-producer
data:
  script.js: |
    import http from "k6/http";
    import { sleep } from "k6";

    export const options = {
      vus: __ENV.VUS ? parseInt(__ENV.VUS) : 5,
      duration: __ENV.DURATION || "24h",
      thresholds: { http_req_failed: ["rate<0.10"] },
    };

    const BASE = __ENV.BASE_URL;
    const endpoints = [
      "/get","/anything","/headers","/uuid","/ip","/user-agent","/cookies",
      "/delay/1","/delay/2","/delay/3",
      "/status/200","/status/204","/status/301","/status/404","/status/418","/status/500"
    ];
    const methods = ["GET","POST","PUT","PATCH","DELETE"];
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    export default function () {
      const m = pick(methods);
      let ep = pick(endpoints);
      if (m === "POST") ep = "/post";
      if (m === "PUT") ep = "/put";
      if (m === "PATCH") ep = "/patch";
      if (m === "DELETE") ep = "/delete";

      const url = `${BASE}${ep}`;
      const params = { headers: { "Content-Type": "application/json", "X-Demo": "k6-producer" } };

      if (m === "GET" || m === "DELETE") {
        http.request(m, url, null, params);
      } else {
        const payload = JSON.stringify({ ts: Date.now(), note: "random load", rnd: Math.random() });
        http.request(m, url, payload, params);
      }
      sleep(Math.random()*1.5 + 0.2);
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-b-producer
  namespace: app-b-producer
  labels:
    app: app-b-producer
spec:
  replicas: 1
  selector:
    matchLabels:
      app: app-b-producer
  template:
    metadata:
      labels:
        app: app-b-producer
    spec:
      containers:
        - name: k6
          image: grafana/k6:0.49.0
          imagePullPolicy: IfNotPresent
          args: ["run","/scripts/script.js"]
          env:
            - name: BASE_URL
              value: http://app-b-consumer.app-b-consumer.svc.cluster.local
            - name: VUS
              value: "5"
            - name: DURATION
              value: 24h
          volumeMounts:
            - name: k6-scripts
              mountPath: /scripts
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 300m
              memory: 256Mi
      volumes:
        - name: k6-scripts
          configMap:
            name: k6-httpbin-script
            items:
              - key: script.js
                path: script.js
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-httpbin-script
  namespace: app-c-producer
data:
  script.js: |
    import http from "k6/http";
    import { sleep } from "k6";

    export const options = {
      vus: __ENV.VUS ? parseInt(__ENV.VUS) : 5,
      duration: __ENV.DURATION || "24h",
      thresholds: { http_req_failed: ["rate<0.10"] },
    };

    // Comma-separated list of base URLs to target, e.g. "http://svc-a,http://svc-b"
    const TARGETS = (__ENV.TARGETS || "").split(",").map(s => s.trim()).filter(Boolean);
    if (TARGETS.length === 0) {
      throw new Error("TARGETS env var must provide at least one URL");
    }

    const endpoints = [
      "/get","/anything","/headers","/uuid","/ip","/user-agent","/cookies",
      "/delay/1","/delay/2","/delay/3",
      "/status/200","/status/204","/status/301","/status/404","/status/418","/status/500"
    ];
    const methods = ["GET","POST","PUT","PATCH","DELETE"];
    const pick = arr => arr[Math.floor(Math.random()*arr.length)];

    export default function () {
      const base = pick(TARGETS);
      const m = pick(methods);
      let ep = pick(endpoints);
      if (m === "POST") ep = "/post";
      if (m === "PUT") ep = "/put";
      if (m === "PATCH") ep = "/patch";
      if (m === "DELETE") ep = "/delete";

      const url = `${base}${ep}`;
      const params = { headers: { "Content-Type": "application/json", "X-Demo": "k6-app-c" } };

      if (m === "GET" || m === "DELETE") {
        http.request(m, url, null, params);
      } else {
        const payload = JSON.stringify({ ts: Date.now(), note: "random load", rnd: Math.random() });
        http.request(m, url, payload, params);
      }
      sleep(Math.random()*1.5 + 0.2);
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-c-producer
  namespace: app-c-producer
  labels:
    app: app-c-producer
spec:
  replicas: 1
  selector:
    matchLabels:
      app: app-c-producer
  template:
    metadata:
      labels:
        app: app-c-producer
    spec:
      containers:
        - name: k6
          image: grafana/k6:0.49.0
          imagePullPolicy: IfNotPresent
          args: ["run","/scripts/script.js"]
          env:
            - name: TARGETS
              value: http://app-a-consumer.app-a-consumer.svc.cluster.local,http://app-b-consumer.app-b-consumer.svc.cluster.local
            - name: VUS
              value: "5"
            - name: DURATION
              value: 24h
          volumeMounts:
            - name: k6-scripts
              mountPath: /scripts
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 300m
              memory: 256Mi
      volumes:
        - name: k6-scripts
          configMap:
            name: k6-httpbin-script
            items:
              - key: script.js
                path: script.js
